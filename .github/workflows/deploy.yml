name: Deploy to Server

on:
  push:
    branches: [main]

env:
  REMOTE_PATH: /root/prime-couture
  
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Basic backend build check
        uses: pnpm/action-setup@v4
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install and build API
        run: |
          cd server
            pnpm i --no-frozen-lockfile --ignore-scripts
          pnpm lint --fix
          pnpm exec prisma generate
          pnpm build

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          PORT="${{ secrets.SSH_PORT }}"
          if [ -z "$PORT" ]; then PORT=22; fi
          ssh-keyscan -p "$PORT" "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Test SSH connection
        run: ssh -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "echo SSH connection established"

      - name: Sync repo to server
        run: |
          PORT="${{ secrets.SSH_PORT }}"
          if [ -z "$PORT" ]; then PORT=22; fi
          rsync -avz --delete \
            --exclude='.git' --exclude='node_modules' --exclude='dist' \
            -e "ssh -p $PORT -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.REMOTE_PATH }}/

      - name: Build and restart services
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            REMOTE_PATH="${{ env.REMOTE_PATH }}"
            cd "$REMOTE_PATH/deploy"
            docker compose pull
            docker compose build --pull
            docker compose up -d --remove-orphans
